name: Tests

on:
  push:
    branches: [ main, phase-7-testing ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      neo4j:
        image: neo4j:5.13-community
        env:
          NEO4J_AUTH: neo4j/testpassword
          NEO4J_PLUGINS: '["apoc"]'
        ports:
          - 7687:7687
          - 7474:7474
        options: >-
          --health-cmd "cypher-shell -u neo4j -p testpassword 'RETURN 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4
    
    - name: Free Disk Space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        df -h
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        echo "$HOME/.local/bin" >> $GITHUB_PATH
    
    - name: Configure Poetry
      run: |
        poetry config virtualenvs.create true
        poetry config virtualenvs.in-project true
    
    - name: Cache Poetry dependencies
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}
        restore-keys: |
          venv-${{ runner.os }}-
    
    - name: Install dependencies (excluding heavy packages)
      run: |
        poetry install --no-interaction --no-root
        # Skip pymupdf and other heavy dependencies for CI
        poetry remove pymupdf || true
    
    - name: Install project
      run: poetry install --no-interaction
    
    - name: Wait for Neo4j
      run: |
        timeout 60 bash -c 'until echo > /dev/tcp/localhost/7687; do sleep 1; done'
    
    - name: Run unit tests (selective)
      env:
        NEO4J_URI: bolt://localhost:7687
        NEO4J_USER: neo4j
        NEO4J_PASSWORD: testpassword
      run: |
        poetry run pytest tests/test_ai.py tests/test_ingestion.py tests/test_gemini_client.py tests/test_conversion_script.py tests/test_batch_processor.py tests/test_s2_client.py -v --ignore=tests/test_parsing.py --ignore=tests/test_ml_pipeline.py
    
    - name: Run integration tests
      env:
        NEO4J_URI: bolt://localhost:7687
        NEO4J_USER: neo4j
        NEO4J_PASSWORD: testpassword
      run: |
        poetry run pytest tests/test_knowledge.py tests/test_api.py -v
    
    # Disabled comprehensive coverage to avoid space issues
    # - name: Generate coverage report
    #   env:
    #     NEO4J_URI: bolt://localhost:7687
    #     NEO4J_USER: neo4j
    #     NEO4J_PASSWORD: testpassword
    #   run: |
    #     poetry run pytest tests/ --cov=packages --cov=apps --cov-report=xml --cov-report=term
    
    # - name: Upload coverage to Codecov
    #   uses: codecov/codecov-action@v3
    #   with:
    #     file: ./coverage.xml
    #     flags: unittests
    #     name: codecov-umbrella
    #     fail_ci_if_error: false

  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        echo "$HOME/.local/bin" >> $GITHUB_PATH
    
    - name: Install dependencies
      run: |
        poetry install --no-interaction --no-root
        poetry install --no-interaction
    
    - name: Run ruff (linting)
      run: |
        poetry run ruff check packages/ apps/ tests/ || true
    
    - name: Run ruff (formatting check)
      run: |
        poetry run ruff format --check packages/ apps/ tests/ || true
    
    - name: Run mypy (type checking)
      run: |
        poetry run mypy packages/ apps/ --ignore-missing-imports || true

  security:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        echo "$HOME/.local/bin" >> $GITHUB_PATH
    
    - name: Check for security vulnerabilities
      run: |
        poetry install --no-interaction --no-root
        poetry run pip install safety
        poetry run safety check || true